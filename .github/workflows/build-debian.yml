name: Build Debian Package

on:
  push:
    branches: [ main, master ]
    # ç§»é™¤ tags è§¦å‘ï¼Œé¿å…ä¸Ž release.yml å†²çª
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      create_release:
        description: 'æ˜¯å¦åˆ›å»ºç‹¬ç«‹çš„ Debian Release'
        required: false
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases
      packages: write  # Required to upload release assets
    steps:
      - name: ðŸš€ Start build
        run: echo "ðŸš€ Building mdict-rs Debian package"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥æ­£ç¡®ç”Ÿæˆç‰ˆæœ¬å·

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          target: x86_64-unknown-linux-gnu

      # æ·»åŠ ç¼“å­˜
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          # åªæœ‰å½“è¿™äº›æ–‡ä»¶å˜åŒ–æ—¶æ‰é‡å»ºç¼“å­˜
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          # ç¼“å­˜æ•´ä¸ªtargetç›®å½•å’Œcargoæ³¨å†Œè¡¨
          cache-on-failure: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev pkg-config build-essential

      - name: Build release binary
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --target x86_64-unknown-linux-gnu --bin mdict-rs

      - name: Generate version number
        id: version
        run: |
          # å°è¯•ä½¿ç”¨gitæ ‡ç­¾ä½œä¸ºç‰ˆæœ¬å·ï¼ˆç§»é™¤vå‰ç¼€ï¼‰
          GIT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [[ -n "$GIT_TAG" && "$GIT_TAG" =~ ^v[0-9].* ]]; then
            # æœ‰æ ‡ç­¾ä¸”æ ¼å¼æ­£ç¡®ï¼Œä½¿ç”¨æ ‡ç­¾ç‰ˆæœ¬
            VERSION="${GIT_TAG#v}"
          else
            # æ²¡æœ‰åˆé€‚çš„æ ‡ç­¾ï¼Œä½¿ç”¨æ—¥æœŸ+æäº¤å“ˆå¸Œä½œä¸ºç‰ˆæœ¬å·
            COMMIT_HASH=$(git rev-parse --short HEAD)
            DATE=$(date +%Y%m%d)
            VERSION="0.1.0~${DATE}.${COMMIT_HASH}"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç”Ÿæˆçš„ç‰ˆæœ¬å·ï¼š$VERSION"

      - name: Create Debian package structure
        run: |
          mkdir -p debian/DEBIAN
          mkdir -p debian/usr/bin
          mkdir -p debian/usr/share/doc/mdict-rs
          mkdir -p debian/usr/share/mdict-rs/static
          mkdir -p debian/usr/share/mdict-rs/mdx
          mkdir -p debian/etc/systemd/system
          
          # æ‹·è´äºŒè¿›åˆ¶æ–‡ä»¶
          cp target/x86_64-unknown-linux-gnu/release/mdict-rs debian/usr/bin/
          chmod +x debian/usr/bin/mdict-rs
          
          # æ‹·è´é™æ€èµ„æºæ–‡ä»¶
          cp -r resources/static/* debian/usr/share/mdict-rs/static/
          
          # æ‹·è´æ–‡æ¡£
          cp README.md debian/usr/share/doc/mdict-rs/ 2>/dev/null || echo "No README.md found"
          cp WARP.md debian/usr/share/doc/mdict-rs/ 2>/dev/null || echo "No WARP.md found"
          
          # åˆ›å»ºç¤ºä¾‹é…ç½®ç›®å½•
          mkdir -p debian/usr/share/mdict-rs/mdx/en
          echo "# Place your .mdx dictionary files here" > debian/usr/share/mdict-rs/mdx/README.txt
          
          # åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
          cat > debian/etc/systemd/system/mdict-rs.service << 'EOF'
          [Unit]
          Description=MDX Dictionary Server
          After=network.target
          
          [Service]
          Type=simple
          User=mdict-rs
          Group=mdict-rs
          WorkingDirectory=/usr/share/mdict-rs
          ExecStart=/usr/bin/mdict-rs
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # åˆ›å»ºæŽ§åˆ¶æ–‡ä»¶
          cat > debian/DEBIAN/control << EOF
          Package: mdict-rs
          Version: ${{ env.VERSION }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libsqlite3-0 (>= 3.7.0)
          Maintainer: MDict-RS Team <mdict-rs@example.com>
          Homepage: https://github.com/your-username/mdict-rs
          Description: Web-based MDX dictionary server
           A Rust-based web application that serves MDX format dictionary files
           through a web interface. Features include:
           .
           - Parses MDX v2.0 dictionary files with encryption support
           - Creates SQLite indexes for fast lookups  
           - Serves web interface on localhost:8181
           - Supports multiple dictionary files simultaneously
           - Automatic redirect resolution for cross-references
          EOF
          
          # åˆ›å»ºpostinstè„šæœ¬ï¼ˆå®‰è£…åŽæ‰§è¡Œï¼‰
          cat > debian/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          
          # åˆ›å»ºç”¨æˆ·å’Œç»„
          if ! getent group mdict-rs > /dev/null 2>&1; then
              addgroup --system mdict-rs
          fi
          
          if ! getent passwd mdict-rs > /dev/null 2>&1; then
              adduser --system --ingroup mdict-rs --home /usr/share/mdict-rs --shell /bin/false mdict-rs
          fi
          
          # è®¾ç½®æ–‡ä»¶æƒé™
          chown -R mdict-rs:mdict-rs /usr/share/mdict-rs
          chmod 755 /usr/share/mdict-rs
          
          # é‡æ–°åŠ è½½systemd
          systemctl daemon-reload
          
          echo "mdict-rs installed successfully!"
          echo "1. Place your .mdx files in /usr/share/mdict-rs/mdx/"
          echo "2. Update configuration if needed"
          echo "3. Start service: sudo systemctl start mdict-rs"
          echo "4. Enable auto-start: sudo systemctl enable mdict-rs"
          echo "5. Access: http://localhost:8181"
          EOF
          
          # åˆ›å»ºprermè„šæœ¬ï¼ˆå¸è½½å‰æ‰§è¡Œï¼‰
          cat > debian/DEBIAN/prerm << 'EOF'
          #!/bin/bash
          set -e
          
          # åœæ­¢æœåŠ¡
          if systemctl is-active --quiet mdict-rs; then
              systemctl stop mdict-rs
          fi
          
          if systemctl is-enabled --quiet mdict-rs; then
              systemctl disable mdict-rs
          fi
          EOF
          
          # è®¾ç½®è„šæœ¬æƒé™
          chmod 755 debian/DEBIAN/postinst debian/DEBIAN/prerm

      - name: Build Debian package
        run: |
          dpkg-deb --build debian
          mv debian.deb mdict-rs_${{ env.VERSION }}_amd64.deb

      - name: Verify package
        run: |
          echo "ðŸ“¦ Package contents:"
          dpkg-deb -c mdict-rs_${{ env.VERSION }}_amd64.deb
          echo ""
          echo "ðŸ“‹ Package info:"
          dpkg-deb -I mdict-rs_${{ env.VERSION }}_amd64.deb

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mdict-rs-debian
          path: mdict-rs_*.deb

      # ä»…åœ¨æ‰‹åŠ¨è§¦å‘ä¸”æŒ‡å®šåˆ›å»º Release æ—¶æ‰åˆ›å»º
      - name: Create Debian Release
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: debian-${{ env.VERSION }}
          name: "Debian Package v${{ env.VERSION }}"
          files: mdict-rs_*.deb
          draft: false
          prerelease: true
          body: |
            ## ðŸ“¦ mdict-rs Debian Package
            
            ### å®‰è£…å‘½ä»¤
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/debian-${{ env.VERSION }}/mdict-rs_${{ env.VERSION }}_amd64.deb
            sudo dpkg -i mdict-rs_${{ env.VERSION }}_amd64.deb
            sudo apt-get install -f
            ```
          body: |
            ## ðŸ“¦ mdict-rs Debian Package Release
            
            ### Installation
            ```bash
            # Download and install
            wget https://github.com/your-username/mdict-rs/releases/download/${{ github.ref_name }}/mdict-rs_${{ env.VERSION }}_amd64.deb
            sudo dpkg -i mdict-rs_${{ env.VERSION }}_amd64.deb
            sudo apt-get install -f  # Fix any missing dependencies
            ```
            
            ### Quick Start
            ```bash
            # Place your .mdx files
            sudo cp your-dictionary.mdx /usr/share/mdict-rs/mdx/
            
            # Start the service
            sudo systemctl start mdict-rs
            sudo systemctl enable mdict-rs
            
            # Access the dictionary
            open http://localhost:8181
            ```
            
            ### What's Included
            - Pre-compiled binary for x86_64 Linux
            - Systemd service configuration
            - Static web resources
            - Automatic user/group creation
            - Example configuration