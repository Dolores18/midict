name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write  # Required to create releases and tags
  packages: write  # Required to upload release assets
  actions: read    # Required to download artifacts

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux targets
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cross: false
            artifact_name: mdict-rs
            asset_name: mdict-rs-linux-x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            cross: false
            artifact_name: mdict-rs
            asset_name: mdict-rs-linux-x86_64-musl
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            cross: true
            artifact_name: mdict-rs
            asset_name: mdict-rs-linux-aarch64
          
          # macOS targets
          - os: macos-latest
            target: x86_64-apple-darwin
            cross: false
            artifact_name: mdict-rs
            asset_name: mdict-rs-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            cross: false
            artifact_name: mdict-rs
            asset_name: mdict-rs-macos-aarch64
          
          # Windows targets
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false
            artifact_name: mdict-rs.exe
            asset_name: mdict-rs-windows-x86_64.exe

    steps:
      - name: ğŸš€ Start build for ${{ matrix.target }}
        run: echo "ğŸš€ Building mdict-rs for ${{ matrix.target }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥æ­£ç¡®ç”Ÿæˆç‰ˆæœ¬å·

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          target: ${{ matrix.target }}

      # æ·»åŠ ç¼“å­˜
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          cache-on-failure: true

      # Linux dependencies
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-musl" ]]; then
            sudo apt-get install -y musl-tools musl-dev
          fi
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          fi
          sudo apt-get install -y libsqlite3-dev pkg-config build-essential

      # Install cross for cross-compilation
      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      # Generate version info
      - name: Generate version and build info
        id: release_info
        shell: bash
        run: |
          # å°è¯•ä½¿ç”¨gitæ ‡ç­¾ä½œä¸ºç‰ˆæœ¬å·
          GIT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)
          
          if [[ -n "$GIT_TAG" && "$GIT_TAG" =~ ^v[0-9].* ]]; then
            # æœ‰æ ‡ç­¾ä¸”æ ¼å¼æ­£ç¡®ï¼Œä½¿ç”¨æ ‡ç­¾ç‰ˆæœ¬
            VERSION="${GIT_TAG#v}"
            BUILD_IDENTIFIER="$VERSION"
          else
            # æ²¡æœ‰åˆé€‚çš„æ ‡ç­¾ï¼Œä½¿ç”¨æ—¥æœŸ+æäº¤å“ˆå¸Œä½œä¸ºç‰ˆæœ¬å·
            VERSION="0.1.0-dev.${DATE}.${COMMIT_HASH}"
            BUILD_IDENTIFIER="${DATE}.${COMMIT_HASH}"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_IDENTIFIER=$BUILD_IDENTIFIER" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_identifier=$BUILD_IDENTIFIER" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          
          echo "ç”Ÿæˆçš„ç‰ˆæœ¬å·ï¼š$VERSION"
          echo "æ„å»ºæ ‡è¯†ï¼š$BUILD_IDENTIFIER"

      # Build binary
      - name: Build binary
        shell: bash
        run: |
          if [[ "${{ matrix.cross }}" == "true" ]]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      # Package binary
      - name: Package binary
        shell: bash
        run: |
          mkdir -p release/
          
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} release/${{ matrix.asset_name }}
          else
            cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} release/${{ matrix.asset_name }}
            chmod +x release/${{ matrix.asset_name }}
          fi
          
          # Copy static resources if they exist
          if [[ -d "resources" ]]; then
            cp -r resources release/resources
          fi
          
          # Create version info file
          cat > release/version.json << EOF
          {
            "version": "${{ env.VERSION }}",
            "build_identifier": "${{ env.BUILD_IDENTIFIER }}",
            "target": "${{ matrix.target }}",
            "commit_hash": "${{ steps.release_info.outputs.commit_hash }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mdict-rs-${{ matrix.target }}
          path: release/*

  # Create releases
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write  # Required to create releases
      packages: write  # Required to upload release assets
      actions: read    # Required to download artifacts
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Generate release info
      - name: Generate release info
        id: release_info
        run: |
          GIT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)
          
          if [[ -n "$GIT_TAG" && "$GIT_TAG" =~ ^v[0-9].* ]]; then
            VERSION="${GIT_TAG#v}"
            BUILD_IDENTIFIER="$VERSION"
            IS_RELEASE="true"
          else
            VERSION="0.1.0-dev.${DATE}.${COMMIT_HASH}"
            BUILD_IDENTIFIER="${DATE}.${COMMIT_HASH}"
            IS_RELEASE="false"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_identifier=$BUILD_IDENTIFIER" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

      # Download all artifacts
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # Prepare release assets
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          echo "ğŸ“‚ æ£€æŸ¥ä¸‹è½½çš„ artifacts:"
          ls -la artifacts/
          
          # Copy all binaries and rename them
          for dir in artifacts/mdict-rs-*; do
            if [[ -d "$dir" ]]; then
              target=$(basename "$dir" | sed 's/mdict-rs-//')
              echo "ğŸ” å¤„ç†ç›®æ ‡: $target"
              echo "ğŸ“ ç›®å½•å†…å®¹:"
              ls -la "$dir/"
              
              # æ ¹æ®ç›®æ ‡å¹³å°æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶
              if [[ "$target" == "x86_64-pc-windows-msvc" ]]; then
                # Windows binary - æŸ¥æ‰¾ .exe æ–‡ä»¶
                for file in "$dir"/*; do
                  if [[ -f "$file" && "$file" == *.exe && "$file" != *version.json ]]; then
                    echo "âœ… æ‰¾åˆ° Windows äºŒè¿›åˆ¶æ–‡ä»¶: $file"
                    cp "$file" "release-assets/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-${target}.exe"
                    break
                  fi
                done
              else
                # Unix binary - æŸ¥æ‰¾é JSON çš„å¯æ‰§è¡Œæ–‡ä»¶
                for file in "$dir"/*; do
                  if [[ -f "$file" && "$file" != *.json && "$file" != */version.json ]]; then
                    echo "âœ… æ‰¾åˆ° Unix äºŒè¿›åˆ¶æ–‡ä»¶: $file"
                    cp "$file" "release-assets/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-${target}"
                    chmod +x "release-assets/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-${target}"
                    break
                  fi
                done
              fi
              
              # Copy version info
              if [[ -f "$dir/version.json" ]]; then
                cp "$dir/version.json" "release-assets/version-${target}.json"
              fi
              
              # Copy resources if available
              if [[ -d "$dir/resources" ]]; then
                cp -r "$dir/resources" "release-assets/" 2>/dev/null || true
              fi
            fi
          done
          
          # Create main version.json
          cat > release-assets/version.json << EOF
          {
            "version": "${{ steps.release_info.outputs.version }}",
            "build_identifier": "${{ steps.release_info.outputs.build_identifier }}",
            "commit_hash": "${{ steps.release_info.outputs.commit_hash }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "is_release": ${{ steps.release_info.outputs.is_release }},
            "targets": [
              "x86_64-unknown-linux-gnu",
              "x86_64-unknown-linux-musl", 
              "aarch64-unknown-linux-gnu",
              "x86_64-apple-darwin",
              "aarch64-apple-darwin",
              "x86_64-pc-windows-msvc"
            ]
          }
          EOF
          
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶:"
          ls -la release-assets/

      # Create versioned release for tags
      - name: Create versioned release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.release_info.outputs.build_identifier }}
          files: release-assets/*
          draft: false
          prerelease: false
          body: |
            ## ğŸš€ mdict-rs Release v${{ steps.release_info.outputs.version }}
            
            ### ğŸ“¥ å¿«é€Ÿä¸‹è½½ (é€‰æ‹©é€‚åˆæ‚¨ç³»ç»Ÿçš„ç‰ˆæœ¬)
            
            **Linux (æ¨èç”¨äºæœåŠ¡å™¨)**
            - [x86_64 GNU](https://github.com/${{ github.repository }}/releases/download/v${{ steps.release_info.outputs.build_identifier }}/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-unknown-linux-gnu) - æ ‡å‡†Linuxç‰ˆæœ¬
            - [x86_64 MUSL](https://github.com/${{ github.repository }}/releases/download/v${{ steps.release_info.outputs.build_identifier }}/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-unknown-linux-musl) - é™æ€é“¾æ¥ç‰ˆæœ¬
            - [ARM64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.release_info.outputs.build_identifier }}/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-aarch64-unknown-linux-gnu) - ARMæœåŠ¡å™¨/æ ‘è“æ´¾
            
            **macOS**
            - [Intel Mac](https://github.com/${{ github.repository }}/releases/download/v${{ steps.release_info.outputs.build_identifier }}/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-apple-darwin)
            - [Apple Silicon (M1/M2)](https://github.com/${{ github.repository }}/releases/download/v${{ steps.release_info.outputs.build_identifier }}/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-aarch64-apple-darwin)
            
            **Windows**
            - [x64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.release_info.outputs.build_identifier }}/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-pc-windows-msvc.exe)
            
            ### ğŸ› ï¸ å®‰è£…å’Œä½¿ç”¨
            
            **Linux/macOS:**
            ```bash
            # ä¸‹è½½å¯¹åº”ç‰ˆæœ¬ (ä»¥Linux x86_64ä¸ºä¾‹)
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.release_info.outputs.build_identifier }}/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-unknown-linux-gnu
            
            # é‡å‘½åå¹¶è®¾ç½®æ‰§è¡Œæƒé™
            mv mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-unknown-linux-gnu mdict-rs
            chmod +x mdict-rs
            
            # è¿è¡Œ
            ./mdict-rs
            ```
            
            **Windows:**
            ```cmd
            # ä¸‹è½½å¹¶è¿è¡Œ
            mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-pc-windows-msvc.exe
            ```
            
            ### ğŸ”— ç‰ˆæœ¬ä¿¡æ¯API
            ```
            https://github.com/${{ github.repository }}/releases/download/v${{ steps.release_info.outputs.build_identifier }}/version.json
            ```
            
            ---
            **æ„å»ºä¿¡æ¯:** `${{ steps.release_info.outputs.commit_hash }}` | **æ„å»ºæ—¶é—´:** $(date -u "+%Y-%m-%d %H:%M:%S UTC")

      # Create/Update latest release for main branch pushes
      - name: Create or update latest release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          files: release-assets/*
          draft: false
          prerelease: true
          body: |
            ## ğŸ”„ mdict-rs Latest Build (Development)
            
            > **âš ï¸ è¿™æ˜¯å¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„åŠŸèƒ½**
            
            ### ğŸ“¥ å¿«é€Ÿä¸‹è½½ (æœ€æ–°å¼€å‘ç‰ˆ)
            
            **Linux (æ¨èç”¨äºæœåŠ¡å™¨)**
            - [x86_64 GNU](https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-unknown-linux-gnu) - æ ‡å‡†Linuxç‰ˆæœ¬
            - [x86_64 MUSL](https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-unknown-linux-musl) - é™æ€é“¾æ¥ç‰ˆæœ¬
            - [ARM64](https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-aarch64-unknown-linux-gnu) - ARMæœåŠ¡å™¨/æ ‘è“æ´¾
            
            **macOS**
            - [Intel Mac](https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-apple-darwin)
            - [Apple Silicon (M1/M2)](https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-aarch64-apple-darwin)
            
            **Windows**
            - [x64](https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-pc-windows-msvc.exe)
            
            ### ğŸ”— ç‰ˆæœ¬ä¿¡æ¯API
            ```
            https://github.com/${{ github.repository }}/releases/download/latest/version.json
            ```
            
            ---
            **å¼€å‘ç‰ˆæœ¬:** `${{ steps.release_info.outputs.build_identifier }}` | **æäº¤:** `${{ steps.release_info.outputs.commit_hash }}` | **æ„å»ºæ—¶é—´:** $(date -u "+%Y-%m-%d %H:%M:%S UTC")

      - name: Display download links
        run: |
          echo "âœ… åŒReleaseåˆ›å»ºå®Œæˆ"
          echo ""
          echo "ğŸ“¦ äºŒè¿›åˆ¶ç‰ˆæœ¬ä¿¡æ¯:"
          echo "   å®é™…ç‰ˆæœ¬: ${{ steps.release_info.outputs.version }}"
          echo "   æ„å»ºæ ‡è¯†: ${{ steps.release_info.outputs.build_identifier }}"
          echo ""
          if [[ "${{ steps.release_info.outputs.is_release }}" == "true" ]]; then
            echo "ğŸ”— ç‰ˆæœ¬åŒ–Releaseé¡µé¢:"
            echo "   https://github.com/${{ github.repository }}/releases/tag/v${{ steps.release_info.outputs.build_identifier }}"
          fi
          echo ""
          echo "ğŸ”— Lateståˆ«åé¡µé¢ (å¼€å‘ç‰ˆ):"
          echo "   https://github.com/${{ github.repository }}/releases/latest"
          echo ""
          echo "ğŸ“¦ ä¸»è¦ä¸‹è½½é“¾æ¥:"
          echo "   Linux x64: https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-unknown-linux-gnu"
          echo "   macOS x64: https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-apple-darwin"
          echo "   macOS ARM: https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-aarch64-apple-darwin"
          echo "   Windows: https://github.com/${{ github.repository }}/releases/download/latest/mdict-rs-${{ steps.release_info.outputs.build_identifier }}-x86_64-pc-windows-msvc.exe"
          echo ""
          echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯API:"
          echo "   Latest: https://github.com/${{ github.repository }}/releases/download/latest/version.json"
          if [[ "${{ steps.release_info.outputs.is_release }}" == "true" ]]; then
            echo "   ç‰ˆæœ¬åŒ–: https://github.com/${{ github.repository }}/releases/download/v${{ steps.release_info.outputs.build_identifier }}/version.json"
          fi
          echo ""
          echo "ğŸŒŸ ç°åœ¨æ”¯æŒå¤šå¹³å°äº¤å‰ç¼–è¯‘ï¼Œé€‰æ‹©é€‚åˆæ‚¨ç³»ç»Ÿçš„ç‰ˆæœ¬ï¼"